<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Learning Objectives</title>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
section.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
</head>
<body>
<div class="frontmatter">
<div class="title"><h1>Learning Objectives</h1></div>
<div class="author"><h2></h2></div>
<div class="date"><h3></h3></div>
</div>
<div class="body">
<h2>syncID: f0e521fd2eca45e3b6eca7b205669ab0
title: “Explore Field Spectra Data - Scaling Ground and Airborne Observations”
description: “Explore the field spectra data product, link field spectra to airborne surface reflectance data.”
dateCreated: 2024-02-12
authors: Bridget Hass
contributors:
estimatedTime: 1 - 1.5 Hours
packagesLibraries: neonUtilities, geoNEON, terra, rhdf5, ggplot2, data.table, dplyr,
topics: hyperspectral, foliar traits
languagesTool: R
dataProduct: DP1.30012.001, DP1.10026.001, DP3.30006.001
code1: <a href="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/explore-field-spectra.R">https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/explore-field-spectra.R</a>
tutorialSeries:
urlTitle: scale-spectra</h2>
<p>In this tutorial, we will go through a scaling exercise to link the <a href="https://data.neonscience.org/data-products/DP1.30012.001" target="_blank">field spectral reflectance</a> and airborne <a href="https://data.neonscience.org/data-products/DP3.30006.001" target="_blank">spectrometer orthorectified surface directional reflectance</a>. We will also tie in the <a href="https://data.neonscience.org/data-products/DP1.10026.001" target="_blank">plant foliar traits</a> data, which contains the geographic information associated with the field spectra data.</p>
<p>Field spectral reflectance provide information about individual leaves or foliage, and samples such as these are often used as spectral endmembers in classification applications. A collection of these spectral data can comprise a spectral library, eg. the <a href="https://www.usgs.gov/labs/spectroscopy-lab/science/spectral-library" target="_blank">USGS Spectral Library</a>. This NEON data product is collected on an opportunistic basis, typically in conjunction with NEON AOP overflights and in coordination with TOS Canopy Foliage Sampling. AOP typically collects spectra at 1-2 sites per year, so it is currently available at a subset of the NEON sites. The tutorial also demonstrates how to programmatically find which data are available.</p>
<div id="ds-objectives" markdown="1">
<h2 id="learning-objectives">Learning Objectives</h2>
<p>After completing this activity, you will be able to:</p>
<ul>
<li>Determine the available field spectra data sets</li>
<li>Load and plot field spectra data for a given site</li>
<li>Understand the data and metadata associated with the field spectra data product</li>
<li>Create a summary plot of leaf clip spectral signatures for a site, and grouped by the taxon ID</li>
<li>Understand uncertainty associated with the foliar spectra data</li>
<li>Link field spectra data to foliar trait data to determine the precise location of leaf clip samples</li>
<li>Compare the field spectra from leaf clip samples with airborne surface reflectance data of the pixel where the leaf-clip sample was taken</li>
</ul>
<h2 id="things-you-ll-need-to-complete-this-tutorial">Things You’ll Need To Complete This Tutorial</h2>
<p>You will need the most current version of R and, preferably, <code>RStudio</code> loaded on your computer to complete this tutorial.</p>
<h3 id="install-r-packages">Install R Packages</h3>
<ul>
<li><strong>neonUtilities:</strong> <code>install.packages(&quot;neonUtilities&quot;)</code></li>
<li><strong>geoNEON:</strong> install.packages(“devtools”), devtools::install_github(“NEONScience/NEON-geolocation/geoNEON”)</li>
<li><strong>ggplot2:</strong> <code>install.packages(&quot;ggplot2&quot;)</code></li>
<li><strong>data.table:</strong> <code>install.packages(&quot;data.table&quot;)</code></li>
<li><strong>dplyr:</strong> <code>install.packages(&quot;dplyr&quot;)</code></li>
<li><strong>rhdf5:</strong> <code>install.packages(&quot;rhdf5&quot;)</code></li>
<li><strong>terra:</strong> <code>install.packages(&quot;terra&quot;)</code></li>
</ul>
</div>
<p>First, load the required libraries.</p>
<pre><code>library(neonUtilities)

library(geoNEON)

library(ggplot2)

library(data.table)

library(dplyr)

library(rhdf5)

library(terra)
</code></pre>
<p>Before downloading the data, we can explore the data product using the <code>neonUtilities::getProductInfo</code>. Let’s take a look at the field spectra data product as follows. You can take a look at various components of the <code>field_spectra_info</code> variable as well by un-commentning the lines starting with <code>View</code>.</p>
<pre><code>field_spectra_info &lt;- neonUtilities::getProductInfo('DP1.30012.001')

field_spectra_info$siteCodes$siteCode

##  [1] &quot;DSNY&quot; &quot;GRSM&quot; &quot;GUAN&quot; &quot;HEAL&quot; &quot;ORNL&quot; &quot;OSBS&quot; &quot;PUUM&quot; &quot;RMNP&quot; &quot;SERC&quot; &quot;STEI&quot; &quot;TREE&quot; &quot;UNDE&quot; &quot;WREF&quot; &quot;YELL&quot;

#View(field_spectra_info$siteCodes)

#View(field_spectra_info$siteCodes$availableDataUrls)
</code></pre>
<p>We can see that there are data available at 14 sites, as of 2023.</p>
<p>Now that we know what data are available, let’s take a look at one of the sites: <a href="https://www.neonscience.org/field-sites/rmnp" target="_blank">Rocky Mountain National Park (RMNP)</a> in Colorado. We’ll use data from this site to demonstrate some exploratory analysis you might start with when working with the field spectral data. To load this field spectra data directly into R, you can use the <code>neonUtilities::loadByProduct</code> function, specifying the data product ID (dpID) and site. Since this product is collected fairly infrequently, to date there is only one collection per year of this for a subset of sites, so specifying the year-month in addition to the site is not necessary. This data is not too large in volume, so it should be fine to set the option <code>check.size=FALSE</code>.</p>
<pre><code>field_spectra &lt;- loadByProduct(dpID='DP1.30012.001',
                              site='RMNP',
                              package=&quot;expanded&quot;,
                              check.size=FALSE)
</code></pre>
<p>Let’s take a look at all the associated data contained in this product, using the <code>names</code> function:</p>
<pre><code>names(field_spectra)

##  [1] &quot;categoricalCodes_30012&quot;      &quot;citation_30012_RELEASE-2024&quot; &quot;fsp_boutMetadata&quot;            &quot;fsp_sampleMetadata&quot;          &quot;fsp_spectralData&quot;           
##  [6] &quot;issueLog_30012&quot;              &quot;per_sample&quot;                  &quot;readme_30012&quot;                &quot;validation_30012&quot;            &quot;variables_30012&quot;
</code></pre>
<p>We encourage looking at all of these variables to learn more about the data product, but you can find the actual data stored in three of these variables: <code>fsp_boutMetadata</code>, <code>fsp_sampleMetadata</code>, and <code>fsp_spectralData</code>. Next, we can merge the data and metadata into a single table as follows.</p>
<pre><code>spectra_merge &lt;- merge(field_spectra$fsp_spectralData,field_spectra$fsp_sampleMetadata,by=&quot;spectralSampleID&quot;) 
</code></pre>
<p>You can use <code>View(spectra_merge)</code> to see the contents of this dataframe, or alternatively you could just print the variable name. The code below displays all the column names of this dataframe. We’ll just show the head (or first 6 rows) of this data frame here, including a subset of the columns.</p>
<pre><code>colnames(spectra_merge)

##  [1] &quot;spectralSampleID&quot;         &quot;uid.x&quot;                    &quot;software&quot;                 &quot;locationID.x&quot;             &quot;collectDate.x&quot;            &quot;spectralSampleCode.x&quot;    
##  [7] &quot;downloadFileUrl&quot;          &quot;downloadFileName&quot;         &quot;processedBy&quot;              &quot;reviewedBy&quot;               &quot;remarks.x&quot;                &quot;dataQF.x&quot;                
## [13] &quot;publicationDate.x&quot;        &quot;release.x&quot;                &quot;uid.y&quot;                    &quot;locationID.y&quot;             &quot;domainID&quot;                 &quot;siteID&quot;                  
## [19] &quot;plotID&quot;                   &quot;plotType&quot;                 &quot;nlcdClass&quot;                &quot;geodeticDatum&quot;            &quot;decimalLatitude&quot;          &quot;decimalLongitude&quot;        
## [25] &quot;coordinateUncertainty&quot;    &quot;elevation&quot;                &quot;elevationUncertainty&quot;     &quot;altLatitude&quot;              &quot;altLongitude&quot;             &quot;altCoordinateUncertainty&quot;
## [31] &quot;collectDate.y&quot;            &quot;eventID&quot;                  &quot;cfcIndividual&quot;            &quot;taxonID&quot;                  &quot;scientificName&quot;           &quot;sampleID&quot;                
## [37] &quot;sampleCode&quot;               &quot;individualID&quot;             &quot;plantStatus&quot;              &quot;leafStatus&quot;               &quot;leafAge&quot;                  &quot;leafExposure&quot;            
## [43] &quot;leafSamplePosition&quot;       &quot;targetType&quot;               &quot;targetStatus&quot;             &quot;measurementVenue&quot;         &quot;measurementDate&quot;          &quot;leafArrangement&quot;         
## [49] &quot;spectralSampleCode.y&quot;     &quot;remarks.y&quot;                &quot;collectedBy&quot;              &quot;recordedBy&quot;               &quot;dataQF.y&quot;                 &quot;publicationDate.y&quot;       
## [55] &quot;release.y&quot;

head(spectra_merge[c(&quot;spectralSampleID&quot;,&quot;downloadFileUrl&quot;)])

##         spectralSampleID                                                                                        downloadFileUrl
## 1 FSP_RMNP_20200706_2043 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200706_204320201221T201729.461Z.csv
## 2 FSP_RMNP_20200706_2107 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200706_210720201221T201802.586Z.csv
## 3 FSP_RMNP_20200706_2120 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200706_212020201221T201700.909Z.csv
## 4 FSP_RMNP_20200707_2038 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200707_203820201221T201636.220Z.csv
## 5 FSP_RMNP_20200707_2058 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200707_205820201221T201612.514Z.csv
## 6 FSP_RMNP_20200709_2016 https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200709_201620201221T201540.362Z.csv
</code></pre>
<p>The <code>downloadFileUrl</code> column is where the actual spectral measurements are stored. We can use the R function <code>read.csv</code> to read this data into a data frame directly, for example, we can find some information about the first sample in this data frame as follows:</p>
<pre><code>spectra_merge[1,]$spectralSampleID

## [1] &quot;FSP_RMNP_20200706_2043&quot;

spectra_merge[1,]$downloadFileUrl

## [1] &quot;https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200706_204320201221T201729.461Z.csv&quot;

spectra_merge[1,]$taxonID

## [1] &quot;POTR5&quot;
</code></pre>
<p>To start, we can read in a single field spectral sample, which has the <code>spectralSampleID</code> of FSP_RMNP_20200706_2043.</p>
<pre><code>FSP_RMNP_20200706_2043 &lt;- read.csv(&quot;https://storage.neonscience.org/neon-os-data/data-frame/FSP_RMNP_20200706_204320201221T201729.461Z.csv&quot;)
</code></pre>
<p>This data is mainly composed of 3 columns: <code>wavelength</code>, <code>reflectanceCondition</code>, and <code>reflectance</code>. What is the <code>reflectanceCondition</code>? Let’s look at the unique values represented:</p>
<pre><code>unique(FSP_RMNP_20200706_2043$reflectanceCondition)

## [1] &quot;top of foliage (sunward) on white reference&quot;     &quot;bottom of foliage (downward) on white reference&quot; &quot;black reference&quot;                                
## [4] &quot;top of foliage (sunward) on black reference&quot;     &quot;bottom of foliage (downward) on black reference&quot;
</code></pre>
<p>This <code>reflectanceCondition</code> describes what exactly is being measured. As stated in the Field spectral data Quick Start Guide on the NEON Data Portal <a href="https://data.neonscience.org/data-products/DP1.30012.001" target="_blank">Field spectral data (DP1.30012.001)</a> page, and explained in more detail in the <a href="https://data.neonscience.org/api/v0/documents/NEON_fieldSpectra_userGuide_vC?inline=true" target="_blank">NEON Field Spectra User Guide</a>:</p>
<p>“Spectral reflectance of both the front and back of the sample is measured against a reflective white spectralon reference panel. A black spectralon reference is then measured, followed by spectral transmittance measurements of the front and back of the sample. Reference measurements of the white reference are taken between each leaf measurement.”</p>
<p>When linking with NEON’s airborne spectral dataset (DP3.30006.001), the <code>top of foliage (sunward) on black reference</code> is what we want to use. For this lesson, we will just focus on this reflectance condition. Let’s take a look at the spectra for the single csv we read in:</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-reflectance-conditions-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>And then subset just to the top of foliage on black reference, to plot the reflectance:</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-single-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>So … how can we read the spectral data in for all of the samples collected at RMNP? The code chunk below loops through all the spectral samples and creates a new data frame comprised of the taxonID + date of the fspID, and the reflectance values only of the top of the leaf on the black reference.</p>
<p>Note, it may take a minute or so for this loop to complete.</p>
<pre><code>spectra_list &lt;- list()

for (i in 1:nrow(spectra_merge)) {
  taxonID &lt;- spectra_merge$taxonID[i] # get the taxonID
  url &lt;- spectra_merge$downloadFileUrl[i] # get the data download URL
  refl_data &lt;- read.csv(url) # read the data csv into a dataframe
  # filter to select only the `top on black` reflectanceCondition and keep the reflectance data only
  refl &lt;- refl_data[which(refl_data$reflectanceCondition == &quot;top of foliage (sunward) on black reference&quot;), c(&quot;reflectance&quot;)]
  spectra_list[[i]] &lt;- refl
}

# get the wavelength values corresponding to the subset we selected for each of the spectra

wavelengths &lt;- refl_data[which(refl_data$reflectanceCondition == &quot;top of foliage (sunward) on black reference&quot;), c(&quot;wavelength&quot;)]

spectra_df &lt;- as.data.frame(do.call(cbind, spectra_list)) # make a new dataframe from the spectra_list

# assign the taxonID + fspID to the column names to make unique column names

taxonIDs &lt;- paste0(spectra_merge$taxonID,substr(spectra_merge$spectralSampleID,9,22))

colnames(spectra_df) &lt;- taxonIDs

# assign the wavelength values to a new column

spectra_df$wavelength &lt;- wavelengths
</code></pre>
<p>In order to plot the spectra for each <code>taxonID</code>, we need to rearrange the data frame so that it contains the data in 3 columns: <code>wavelength</code>, <code>variable</code>, and <code>value</code>. We can do this using <code>melt</code> as follows:</p>
<pre><code>## Warning in melt(spectra_df, id = &quot;wavelength&quot;, value.name = &quot;reflectance&quot;, : The melt generic in data.table has been passed a data.frame and will attempt to redirect
## to the relevant reshape2 method; please note that reshape2 is deprecated, and this redirection is now deprecated as well. To continue using melt methods from reshape2
## while both libraries are attached, e.g. melt.list, you can prepend the namespace like reshape2::melt(spectra_df). In the next version, this warning will become an
## error.
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-taxon-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>You’ll note there are a number of spectra with <code>taxonID</code>s of PICOL, PIPOS, and POTR5. We can also plot the spectra grouped by <code>taxonID</code>.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-taxon-spectra2-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>We can see there are 7 different species represented. We can get the count of each of the taxonIDs as follows.</p>
<pre><code>spectra_merge %&gt;% count(taxonID, sort = TRUE)

##   taxonID n
## 1   PICOL 5
## 2   PIPOS 5
## 3   POTR5 5
## 4    PIEN 3
## 5   PIFL2 3
## 6    PSME 3
## 7   ABLAL 1
</code></pre>
<p>Let’s dig in a a little more into the <code>taxonID</code>s` which have multiple field spectra measurements. PICOL, PIPOS, and POTR5 each have 5 samples - these are the more common species at RMNP. Let’s look at the spectra only from PICOL to start. For more details on this species, you can refer to the USDA <a href="https://plants.sc.egov.usda.gov/home/plantProfile?symbol=PICOL" target="_blank">PICOL</a> plant profile page - we can see here that the common name of this species is “Lodgepole Pine”.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>What do you notice about these spectra? It looks like there is some variation between some of the samples, particularly in the visible portion of the spectrum. Let’s go back to the original <code>spectra_merge</code> dataframe to see if we can determine more information about these individual samples. The code below pulls out some relevant columns from the data frame which may explain some of the variation we’re seeing.</p>
<pre><code>spectra_merge[which(spectra_merge$taxonID == &quot;PICOL&quot;), c(&quot;taxonID&quot;,&quot;spectralSampleID&quot;,&quot;plantStatus&quot;,&quot;leafStatus&quot;,&quot;leafAge&quot;,&quot;leafExposure&quot;,&quot;leafSamplePosition&quot;,&quot;targetType&quot;,&quot;targetStatus&quot;,&quot;measurementVenue&quot;,&quot;remarks.y&quot;)]

##    taxonID       spectralSampleID plantStatus leafStatus leafAge leafExposure leafSamplePosition   targetType targetStatus measurementVenue          remarks.y
## 3    PICOL FSP_RMNP_20200706_2120          OK    healthy  mature     part-sun             middle pure foliage        fresh       laboratory               &lt;NA&gt;
## 8    PICOL FSP_RMNP_20200709_2050          OK    healthy  mature       sunlit                top pure foliage        fresh       laboratory               &lt;NA&gt;
## 10   PICOL FSP_RMNP_20200713_1117          OK    healthy  mature       sunlit             middle pure foliage        fresh       laboratory Sampled in AOP lab
## 21   PICOL FSP_RMNP_20200720_1304          OK    healthy  mature       sunlit                top pure foliage        fresh       laboratory Sampled in AOP lab
## 24   PICOL FSP_RMNP_20200721_1243          OK    healthy  mature       sunlit             middle pure foliage        fresh       laboratory               &lt;NA&gt;
</code></pre>
<p>Here, we can see that all the plants have an “OK” status, and all the leaves have a “healthy” status, but we are still seeing some variation in the spectral signatures. This is also to be expected. Note that it appears the absolute values of reflectance vary quite a bit, but the relative reflectance differences, for example between the near infrared (NIR) and visible portions of the spectrum, may be fairly consistent. Let’s test this qualitative observation by computing the NDVI (Normalized Difference Vegetation Index, a normalized ratio between the NIR and red portions of the spectrum) and comparing this index across all samples.</p>
<p>$$
NDVI = \frac{NIR-RED}{NIR+RED}
$$
You can refer to this tutorial for how you would calculate NDVI from the aerial reflectance data: <a href="https://www.neonscience.org/resources/learning-hub/tutorials/create-raster-stack-hsi-hdf5-r#raster-math-creating-ndvi-and-other-vegetation-indices-in-r" target="_blank">Raster Math - Creating NDVI and Other Vegetation Indices in R</a>.</p>
<pre><code>nir &lt;- spectra_df[which.min(abs(750-spectra_df$wavelength)),]

red &lt;- spectra_df[which.min(abs(650-spectra_df$wavelength)),]

ndvi = (nir - red) / (nir + red) 

ndvi = ndvi[1:(length(ndvi)-1)]
</code></pre>
<p>Let’s plot NDVI for all of the samples.</p>
<div class="figure" style="text-align: right">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/ndvi-plot-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>As we can see, the NDVI doesn’t vary too much between the various samples. NDVI is a nice proxy for vegetation health, and could potentially be used in training models using this reflectance data, for example.</p>
<p>Let’s also plot the spectra of the other more common Rocky Mountain species: <a href="https://plants.sc.egov.usda.gov/home/plantProfile?symbol=PIPO" target="_blank">PIPOS (Ponderosa Pine)</a> and <a href="https://plants.sc.egov.usda.gov/home/plantProfile?symbol=POTR5" target="_blank">POTR5 (Quaking Aspen)</a>, to explore some of the typical variation you might see in the spectral signatures of a single species.</p>
<p>First, start with PIPOS (Ponderosa Pine):</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-pipos-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>And then POTR5 (Quaking Aspen):</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-potr5-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Finally, it may be helpful to plot the spectra of two species on the same plot. For this example, we’ll show PICOL (Lodgepole Pine) and POTR5 (Quaking Aspen) together, including all 5 measurements of each.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-potr5-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Here we can see there are some distinct differences in the spectral signatures between these two species.</p>
<h2 id="foliar-trait-data">Foliar Trait Data</h2>
<p>As described in the Field Spectra Data Quick Start Guide, “To find the geographic location of each plant, use the plant crown shapefiles in the Plant foliar physical and chemical properties data product (DP1.10026.001, table cfc_shapefile). For the locations of plants that have not been mapped to shapefiles, follow the instructions in the Data Product User Guide for DP1.10026.001.”</p>
<p>This next section outlines how you would go about finding the geolocation information for the field spectra data. This is necessary if you are doing any sort of scaling exercise with the AOP hyperspectral data, which we will demonstrate next.</p>
<p>Let’s start by looking at the product information for this foliar trait data product.</p>
<pre><code>foliar_trait_info &lt;- neonUtilities::getProductInfo('DP1.10026.001')

#View(foliar_trait_info$siteCodes)

#View(foliar_trait_info$siteCodes$availableDataUrls)
</code></pre>
<p>We can get the <code>availableDataUrls</code> of the RMNP site as follows:</p>
<pre><code># view the RMNP foliar trait available data urls

foliar_trait_info$siteCodes[which(foliar_trait_info$siteCodes$siteCode == 'RMNP'),c(&quot;availableDataUrls&quot;)]

## [[1]]
## [1] &quot;https://data.neonscience.org/api/v0/data/DP1.10026.001/RMNP/2020-07&quot;
</code></pre>
<p>Let’s download the foliar trait data from 2020-07 at RMNP to obtain the precise location information of the foliar spectra samples.</p>
<pre><code>foliar_traits &lt;- loadByProduct(dpID='DP1.10026.001',
                               site='RMNP',
                               startdate='2020-07',
                               package=&quot;expanded&quot;,
                               check.size=FALSE)

## Finding available files
## 
</code></pre>
<p>|<br />
|                                                                                                                                                              |   0%
|<br />
|==============================================================================================================================================================| 100%
##
## Downloading files totaling approximately 1.045671 MB
## Downloading 1 files
##
|<br />
|                                                                                                                                                              |   0%
|<br />
|==============================================================================================================================================================| 100%
##
## Unpacking zip files using 1 cores.
## Stacking table cfc_elementsSummary
## Stacking table lig_externalSummary
## Stacking table cfc_chlorophyllParameters
## Stacking table cfc_chlorophyllSummary
## Stacking table bgc_CNiso_externalSummary
## Stacking operation across a single core.
## Stacking table cfc_carbonNitrogen
## Stacking table cfc_chemistrySubsampling
## Stacking table cfc_chlorophyll
## Stacking table cfc_elements
## Stacking table cfc_fieldData
## Stacking table cfc_lignin
## Stacking table cfc_LMA
## Stacking table cfc_shapefile
## Stacking table vst_mappingandtagging
## Copied the most recent publication of validation file to /stackedFiles
## Copied the most recent publication of categoricalCodes file to /stackedFiles
## Copied the most recent publication of variable definition file to /stackedFiles
## Finished: Stacked 14 data tables and 4 metadata tables!
## Stacking took 1.011186 secs</p>
<pre><code>names(foliar_traits)

##  [1] &quot;bgc_CNiso_externalSummary&quot;   &quot;categoricalCodes_10026&quot;      &quot;cfc_carbonNitrogen&quot;          &quot;cfc_chemistrySubsampling&quot;    &quot;cfc_chlorophyll&quot;            
##  [6] &quot;cfc_chlorophyllParameters&quot;   &quot;cfc_chlorophyllSummary&quot;      &quot;cfc_elements&quot;                &quot;cfc_elementsSummary&quot;         &quot;cfc_fieldData&quot;              
## [11] &quot;cfc_lignin&quot;                  &quot;cfc_LMA&quot;                     &quot;cfc_shapefile&quot;               &quot;citation_10026_RELEASE-2024&quot; &quot;issueLog_10026&quot;             
## [16] &quot;lig_externalSummary&quot;         &quot;readme_10026&quot;                &quot;validation_10026&quot;            &quot;variables_10026&quot;             &quot;vst_mappingandtagging&quot;
</code></pre>
<p>We can use the <code>geoNEON</code> package to obtain the refined geolocation information, based on product-specific rules and spatial designs. For more details on this package, please refer to the <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neon-spatial-data-basics" target="_blank">Access and Work with NEON Geolocation Data</a> tutorial.</p>
<pre><code>vst.loc &lt;- getLocTOS(data=foliar_traits$vst_mappingandtagging,
                     dataProd=&quot;vst_mappingandtagging&quot;)
</code></pre>
<p>Now let’s merge the foliar traits <code>cfc_fieldData</code> with this <code>vst.loc</code> data, which now includes the refined (adjusted) locations.</p>
<pre><code>foliar_traits_loc &lt;- merge(foliar_traits$cfc_fieldData,vst.loc,by=&quot;individualID&quot;)
</code></pre>
<p>Finally, we can merge this <code>foliar_traits_loc</code> data frame with the <code>spectra_merge</code> data frame by the <code>sampleID</code> in order to link the field spectra samples with the geolocation information. Note that there is also a <code>crownPolygonID</code> column, which contains the id of the crown polygon shape file. We will hold off on using this crown polygon for now, but will start by using the adjusted geolocations calculated using <code>geoNEON</code> to obtain the corresponding airborne reflectance data.</p>
<pre><code>spectra_traits &lt;- merge(spectra_merge,foliar_traits_loc,by=&quot;sampleID&quot;)

head(spectra_traits[c(&quot;spectralSampleID&quot;,&quot;locationID.x&quot;,&quot;tagID&quot;,&quot;taxonID&quot;,&quot;stemDistance&quot;,&quot;stemAzimuth&quot;,&quot;adjEasting&quot;,&quot;adjNorthing&quot;)])

##         spectralSampleID          locationID.x tagID taxonID stemDistance stemAzimuth adjEasting adjNorthing
## 1 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3   459058.0     4450439
## 2 FSP_RMNP_20200714_0910 RMNP_019.basePlot.cfc  4352   PIFL2          5.8       143.5   458176.5     4449625
## 3 FSP_RMNP_20200716_1149 RMNP_009.basePlot.cfc  3832   PIFL2         16.9        14.0   459046.8     4450436
## 4 FSP_RMNP_20200709_2050 RMNP_041.basePlot.cfc  2496   PICOL         17.6       278.2   453521.1     4458506
## 5 FSP_RMNP_20200706_2120 RMNP_004.basePlot.cfc  3472   PICOL          5.8        83.0   453949.4     4448624
## 6 FSP_RMNP_20200709_2104 RMNP_041.basePlot.cfc  2510   POTR5         15.0       335.8   453532.4     4458517
</code></pre>
<p>Great, now we have the field spectra data and the corresponding locations of the leaf-clip samples. For the final part of this lesson, we will download the airborne reflectance data, and use some pre-defined functions to read the reflectance data into a <code>terra:rast</code> Spatial Object, and extract the spectral signature of the pixel corresponding to the location of the leaf-clip sample. We can use the <code>neonUtilities::byTileAOP</code> function to download only the 1km x 1km tile that contains the data we’re interested in. Reflectance data can be quite large (~500-600+ MB per tile), so for this example, we’ll only download the single tile needed. We’ll leave the <code>check.size</code> field empty (default is TRUE), which means we will need to enter <code>y</code> in order to continue the download.</p>
<pre><code># set working directory (this will depend on your local environment)

wd &lt;- &quot;~/data/&quot;

setwd(wd)
</code></pre>
<p>We’ll just link a single PICOL leaf-clip sample with the corresponding reflectance spectra of the pixel corresponding to where this sample was located.</p>
<pre><code>FSP_RMNP_PICOL &lt;- spectra_traits[spectra_traits$spectralSampleID == &quot;FSP_RMNP_20200720_1304&quot;,]
</code></pre>
<p>Check the <code>spectralSampleID</code> and <code>taxonID</code>:</p>
<pre><code>FSP_RMNP_PICOL$spectralSampleID

## [1] &quot;FSP_RMNP_20200720_1304&quot;

FSP_RMNP_PICOL$taxonID

## [1] &quot;PICOL&quot;
</code></pre>
<p>Download the reflectance data that encompasses this data point.</p>
<pre><code>byTileAOP(dpID='DP3.30006.001',

          site='RMNP',

          year=2020,

          easting=FSP_RMNP_PICOL$adjEasting,

          northing=FSP_RMNP_PICOL$adjNorthing,

          include.provisional=TRUE,

          savepath=wd)
</code></pre>
<p>This file will be downloaded into a nested subdirectory under the ~/data folder, inside a folder named DP3.30006.001 (the Data Product ID of the aerial reflectance data). The file should show up in this location: ~/data/DP3.30006.001/neon-aop-products/2020/FullSite/D10/2020_RMNP_3/L3/Spectrometer/Reflectance/NEON_D10_RMNP_DP3_455000_4446000_reflectance.h5. Let’s define an <code>h5_file</code> variable that points to the full path to this file.</p>
<pre><code># Define the h5 file name to be opened

h5_file &lt;- paste0(wd,&quot;DP3.30006.001/neon-aop-products/2020/FullSite/D10/2020_RMNP_3/L3/Spectrometer/Reflectance/NEON_D10_RMNP_DP3_455000_4446000_reflectance.h5&quot;)
</code></pre>
<p>Now we can use some pre-defined functions for working with the airborne reflectance data. For more details, please refer to the <a href="https://www.neonscience.org/resources/learning-hub/tutorials/introduction-hyperspectral-remote-sensing-data" target="_blank">Introduction to Hyperspectral Remote Sensing</a> tutorial series.</p>
<pre><code>geth5metadata &lt;- function(h5_file){
  # get the site name
  site &lt;- h5ls(h5_file)$group[2]
  
  # get the wavelengths
  wavelengths &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Metadata/Spectral_Data/Wavelength&quot;))
  
  # get the epsg code
  h5_epsg &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Metadata/Coordinate_System/EPSG Code&quot;))
                    
  # get the Reflectance_Data attributes
  refl_attrs &lt;- h5readAttributes(h5_file,paste0(site,&quot;/Reflectance/Reflectance_Data&quot;))
  
  # grab the UTM coordinates of the spatial extent
  xMin &lt;- refl_attrs$Spatial_Extent_meters[1]
  xMax &lt;- refl_attrs$Spatial_Extent_meters[2]
  yMin &lt;- refl_attrs$Spatial_Extent_meters[3]
  yMax &lt;- refl_attrs$Spatial_Extent_meters[4]
  
  ext &lt;- ext(xMin,xMax,yMin,yMax) # define the extent (left, right, top, bottom)

  no_data &lt;- as.integer(refl_attrs$Data_Ignore_Value)  # define the no data value
  meta_list &lt;- list(&quot;wavelengths&quot; = wavelengths, &quot;crs&quot; = crs, &quot;raster_ext&quot; = ext, &quot;no_data_value&quot; = no_data)
  h5closeAll() # cloes all open h5 instances
  
  return(meta_list)


  band2Raster &lt;- function(h5_file, band, extent, crs, no_data_value){
    site &lt;- h5ls(h5_file)$group[2] # extract the site info
    # read in the raster for the band specified, this will be an array
    refl_array &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Reflectance_Data&quot;),index=list(band,NULL,NULL))
	  refl_matrix &lt;- (refl_array[1,,]) # convert from array to matrix
	  refl_matrix &lt;- t(refl_matrix) # transpose data to fix flipped row and column order
    refl_matrix[refl_matrix == no_data_value] &lt;- NA     # assign data ignore values to NA
    refl_out &lt;- rast(refl_matrix,crs=crs) # write out as a raster
    ext(refl_out) &lt;- extent # assign the extents to the raster
    h5closeAll() # close all open h5 instances
    return(refl_out) # return the terra raster object
}

## Error: &lt;text&gt;:41:0: unexpected end of input
## 39:     return(refl_out) # return the terra raster object
## 40: }
##    ^
</code></pre>
<p>Now that we’ve defined these functions, we can run <code>lapply</code> on the band2Raster function, using all the bands:</p>
<pre><code># get the relevant metadata using the geth5metadata function

h5_meta &lt;- geth5metadata(h5_file)



# get all bands - a consecutive list of integers from 1:426 (# of bands)

all_bands &lt;- as.list(1:length(h5_meta$wavelengths))



# lapply applies the function `band2Raster` to each element in the list `all_bands`

refl_list &lt;- lapply(all_bands,
                    FUN = band2Raster,
                    h5_file = h5_file,
                    extent = h5_meta$raster_ext,
                    crs = h5_meta$crs,
                    no_data_value = h5_meta$no_data_value)



refl_rast &lt;- rast(refl_list)
</code></pre>
<p>Let’s plot a single band (in the red wavelength) of the reflectance tile, for reference.</p>
<pre><code>plot(refl_rast[[58]])

#convert the data frame into a shape file (vector)

m &lt;- vect(cbind(FSP_RMNP_PICOL$adjEasting,
                FSP_RMNP_PICOL$adjNorthing), crs=h5_meta$crs)

# plot

plot(m, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-band58-1.png" alt=" " /></p>
<p>And we can zoom in on the sample location.</p>
<pre><code>x_sub = c(455100, 455200)

y_sub = c(4446500, 4446600)

plot(refl_rast[[58]],xlim=x_sub,ylim=y_sub)

plot(m, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-band58-zoom-1.png" alt=" " /></p>
<p>We can also plot an RGB image. First we’ll run <code>lapply</code> on the band2Raster function, this time using a list only consisting of the RGB bands:</p>
<pre><code>rgb &lt;- list(58,34,19)



# lapply tells R to apply the function to each element in the list

rgb_list &lt;- lapply(rgb,
                    FUN = band2Raster,
                    h5_file = h5_file,
                    extent = h5_meta$raster_ext,
                    crs = h5_meta$crs,
                    no_data_value = h5_meta$no_data_value)



rgb_rast &lt;- rast(rgb_list)
</code></pre>
<p>Plot the RGB of the entire 1km x 1km tile, as well as zoomed in on the sample location.</p>
<pre><code>plotRGB(rgb_rast,stretch='lin',axes=TRUE)

plot(m, col=&quot;red&quot;, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-refl-rgb-1.png" alt=" " /></p>
<pre><code>#zoom in

plotRGB(rgb_rast,stretch='lin',xlim=x_sub,ylim=y_sub)

plot(m, col=&quot;red&quot;, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-refl-rgb-2.png" alt=" " /></p>
<p>Next we can extract the aerial reflectance spectra using the <code>terra::extract</code> function as follows. We’ll create a data frame of the wavelengths and reflectance of that pixel.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/extract-air-refl-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Plot the leaf-clip spectra of this PICOL sample.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-spectra-leafclip-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Finally, let’s make a plot of these two spectra (leaf-clip and aerial reflectance) together.</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-spectra-both-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Why is there a difference between the leaf-clip spectra and the remotely-sensed spectra of the corresponding pixel? Here are a few things to consider …</p>
<p>Each reflectance pixel represents a 1m x 1m area, so it contains an average spectra of all the vegetation and non-vegetation that are contained in that area. For example, a single pixel could contain the reflectance of a mix of leaves as well as branches, and any gaps in the tree canopy (eg. the ground under the tree). This averaging is called “spectral mixing” and you can perform “spectral un-mixing” to decompose an average spectra into it’s component parts. These leaf clip spectra can be used as “end-members”, in classification applications, for example.</p>
<p>Also, it is important to understand that there are uncertainties in the ASD measurements as well as the airborne spectra. There may be some geographic uncertainty associated with both the airborne data (which has 0.5 m horizontal resolution), as well as with the field sample geolocations. There is also some uncertainty in the spectral data itself. For example, there is uncertainty resulting from the atmospheric correction applied when generating the reflectance data from the at-sensor-radiance. Weather conditions during the flight are important to consider as well. The Airborne Observation Platform is typically able to collect the coincident overflights in clear weather, but this may not always be the case. For more on hyperspectral uncertainties and variation, please refer to the <a href="https://data.neonscience.org/api/v0/documents/NEON.DOC.004365vB?inline=true" target="_blank">Spectrometer Mosaic ATBD</a> (Algorithm Theoretical Basis Document).</p>
<h3 id="next-steps">Next Steps</h3>
<p>Hopefully this tutorial provides a bouncing-off point for more exploratory analysis and/or in-depth research. What else might you want to explore, using these three integrated datasets?</p>
<p>Here are some ideas to pursue on your own:</p>
<ol>
<li>
<p>We demonstrated how to plot the field spectral sample together with the aerial reflectance of the pixel. What if there is a geographic mis-match between the field and airborne data? What other approaches could you use to align these datasets (eg. applying a buffer, integrating the CHM data)?</p>
</li>
<li>
<p>Foliar traits datasets for more recent years (including RMNP 2020) include shape files of the polygons of the tree crowns where the samples are taken from. Try pulling in that crown data and plotting the average spectra inside the tree crown area.</p>
</li>
<li>
<p>The foliar trait data is also a key dataset for scaling - for example, a common ecological application would be to develop a foliar trait model from the airborne reflectance data, using the in-situ foliar trait data to train the model. This is beyond the scope of this lesson, but the initial steps for conducting that sort of analysis would be the same.</p>
</li>
</ol>
</div>
</body>
</html>
