<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Explore Field Spectra Data - Scaling Ground and Airborne Observations</title>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
section.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
</head>
<body>
<div class="frontmatter">
<div class="title"><h1>Explore Field Spectra Data - Scaling Ground and Airborne Observations</h1></div>
<div class="author"><h2></h2></div>
<div class="date"><h3></h3></div>
</div>
<div class="body">
<p>In this tutorial, we will go through a scaling exercise to link the <a href="https://data.neonscience.org/data-products/DP1.30012.001" target="_blank">field spectral reflectance</a> and airborne <a href="https://data.neonscience.org/data-products/DP3.30006.001" target="_blank">spectrometer orthorectified surface directional reflectance</a>. We will also tie in the <a href="https://data.neonscience.org/data-products/DP1.10026.001" target="_blank">plant foliar traits</a> data, which contains the geographic information and other metadata about the plants measured for associated with the field spectra data.</p>
<p>Field spectral reflectance provide information about individual leaves or foliage, and samples such as these are often used as spectral end-members in classification applications. A collection of these spectral data can comprise a spectral library, eg. the <a href="https://www.usgs.gov/labs/spectroscopy-lab/science/spectral-library" target="_blank">USGS Spectral Library</a>. This NEON data product is collected on an opportunistic basis, typically in conjunction with NEON Airborne Observation Platform (AOP) overflights and in coordination with TOS Canopy Foliage Sampling. AOP typically collects spectra at 1-2 sites per year, so it is currently available at a subset of the NEON sites. The tutorial also demonstrates how to programmatically determine which data are available.</p>
<div id="ds-objectives" markdown="1">
<h2 id="learning-objectives">Learning Objectives</h2>
<p>After completing this activity, you will be able to:</p>
<ul>
<li>Determine the available field spectra data sets</li>
<li>Load and plot field spectra data for a given site</li>
<li>Understand the data and metadata associated with the field spectra data product</li>
<li>Create a summary plot of leaf clip spectral signatures for a site, and grouped by the taxon ID</li>
<li>Understand uncertainty associated with the foliar spectra data</li>
<li>Link field spectra data to foliar trait data to determine the precise location of leaf clip samples</li>
<li>Compare the field spectra from leaf clip samples with airborne surface reflectance data of the pixel where the leaf-clip sample was taken</li>
</ul>
<h2 id="things-you-ll-need-to-complete-this-tutorial">Things You’ll Need To Complete This Tutorial</h2>
<p>You will need the most current version of R and, preferably, <code>RStudio</code> loaded on your computer to complete this tutorial.</p>
<h3 id="install-r-packages">Install R Packages</h3>
<ul>
<li><strong>neonUtilities:</strong> <code>install.packages(&quot;neonUtilities&quot;)</code></li>
<li><strong>neonOS:</strong> <code>install.packages(&quot;neonOS&quot;)</code></li>
<li><strong>geoNEON:</strong> <code>install.packages(&quot;devtools&quot;)</code>, <code>devtools::install_github(&quot;NEONScience/NEON-geolocation/geoNEON&quot;)</code></li>
<li><strong>ggplot2:</strong> <code>install.packages(&quot;ggplot2&quot;)</code></li>
<li><strong>dplyr:</strong> <code>install.packages(&quot;dplyr&quot;)</code></li>
<li><strong>rhdf5:</strong> <code>install.packages(&quot;rhdf5&quot;)</code></li>
<li><strong>terra:</strong> <code>install.packages(&quot;terra&quot;)</code></li>
</ul>
</div>
<p>First, load the required libraries.</p>
<pre><code>library(neonUtilities)

library(neonOS)

library(geoNEON)

library(ggplot2)

library(dplyr)

library(rhdf5)

library(terra)
</code></pre>
<p>Before downloading the data, we can explore the data product using the <code>neonUtilities::getProductInfo</code>. Let’s take a look at the field spectra data product as follows. You can take a look at various components of the <code>field_spectra_info</code> variable as well by un-commenting the lines starting with <code>View</code>.</p>
<pre><code>field_spectra_info &lt;- neonUtilities::getProductInfo('DP1.30012.001')

#View(field_spectra_info$siteCodes) 

#View(field_spectra_info$siteCodes$availableDataUrls) # list available data urls

field_spectra_info$siteCodes$siteCode # list all available sites

##  [1] &quot;DSNY&quot; &quot;GRSM&quot; &quot;GUAN&quot; &quot;HEAL&quot; &quot;ORNL&quot; &quot;OSBS&quot; &quot;PUUM&quot; &quot;RMNP&quot; &quot;SERC&quot; &quot;STEI&quot; &quot;TREE&quot; &quot;UNDE&quot; &quot;WREF&quot; &quot;YELL&quot;
</code></pre>
<p>We can see that there are data available at 14 sites, as of the end of 2023.</p>
<p>Now that we know what sites have this field spectral data, let’s take a look at one of the sites as an example - <a href="https://www.neonscience.org/field-sites/rmnp" target="_blank">Rocky Mountain National Park (RMNP)</a> in Colorado. We’ll use this site to demonstrate some exploratory analysis you might start with when working with the field spectral data. To load this data directly into R, you can use the <code>neonUtilities::loadByProduct</code> function, specifying the data product ID (dpID) and site. Since this product is collected fairly infrequently, to date there is only one collection per year of this for the subset of sites shown above, so specifying the year-month in addition to the site is not necessary. This data is not too large in volume, so it should be fine to set the option <code>check.size=FALSE</code>. You will need to set package=“expanded” in order to include the actual field spectral data.</p>
<pre><code>field_spectra &lt;- loadByProduct(dpID='DP1.30012.001',
                              site='RMNP',
                              package=&quot;expanded&quot;,
                              check.size=FALSE)
</code></pre>
<p>Let’s take a look at all the associated tables contained in this data product, using the <code>names</code> function:</p>
<pre><code>names(field_spectra)

##  [1] &quot;categoricalCodes_30012&quot;      &quot;citation_30012_RELEASE-2024&quot; &quot;fsp_boutMetadata&quot;            &quot;fsp_sampleMetadata&quot;          &quot;fsp_spectralData&quot;           
##  [6] &quot;issueLog_30012&quot;              &quot;per_sample&quot;                  &quot;readme_30012&quot;                &quot;validation_30012&quot;            &quot;variables_30012&quot;
</code></pre>
<p>We encourage looking at all of these tables to learn more about the data product, but you can find the actual data stored in the variables: <code>fsp_boutMetadata</code> (contains metadata information about this sampling bout), <code>fsp_sampleMetadata</code> (contains relevant metadata about the individual samples), <code>fsp_spectralData</code> (contains information about the individual sample data), and <code>per_sample</code> (contains the wavelength and reflectance data). Next, we can merge the <code>fsp_spectralData</code>, <code>fsp_sampleMetadata</code> and <code>per_sample</code> into a single data frame as follows. For more info on joining OS tables, please refer to <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neonos-duplicates-joins">https://www.neonscience.org/resources/learning-hub/tutorials/neonos-duplicates-joins</a>.</p>
<pre><code>list2env(field_spectra, .GlobalEnv)


spectra_data_metadata &lt;- joinTableNEON(fsp_spectralData,fsp_sampleMetadata)

spectra_data &lt;- merge(spectra_data_metadata,per_sample,by=&quot;spectralSampleID&quot;)
</code></pre>
<p>You can use <code>View(spectra_data)</code> to see the contents of this dataframe, or alternatively you could just print the variable name. The code below displays all the column names of this dataframe. We’ll just show the head (or first 6 rows) of this data frame here, including a few of the columns.</p>
<pre><code>colnames(spectra_data)

##  [1] &quot;spectralSampleID&quot;         &quot;spectralSampleCode.x&quot;     &quot;locationID&quot;               &quot;uid.x&quot;                    &quot;domainID&quot;                
##  [6] &quot;siteID&quot;                   &quot;plotID&quot;                   &quot;plotType&quot;                 &quot;nlcdClass&quot;                &quot;geodeticDatum&quot;           
## [11] &quot;decimalLatitude&quot;          &quot;decimalLongitude&quot;         &quot;coordinateUncertainty&quot;    &quot;elevation&quot;                &quot;elevationUncertainty&quot;    
## [16] &quot;altLatitude&quot;              &quot;altLongitude&quot;             &quot;altCoordinateUncertainty&quot; &quot;collectDate.x&quot;            &quot;eventID&quot;                 
## [21] &quot;cfcIndividual&quot;            &quot;taxonID&quot;                  &quot;scientificName&quot;           &quot;sampleID&quot;                 &quot;sampleCode&quot;              
## [26] &quot;individualID&quot;             &quot;plantStatus&quot;              &quot;leafStatus&quot;               &quot;leafAge&quot;                  &quot;leafExposure&quot;            
## [31] &quot;leafSamplePosition&quot;       &quot;targetType&quot;               &quot;targetStatus&quot;             &quot;measurementVenue&quot;         &quot;measurementDate&quot;         
## [36] &quot;leafArrangement&quot;          &quot;remarks.x&quot;                &quot;collectedBy&quot;              &quot;recordedBy&quot;               &quot;dataQF.x&quot;                
## [41] &quot;publicationDate.x&quot;        &quot;release.x&quot;                &quot;uid.y&quot;                    &quot;software&quot;                 &quot;collectDate.y&quot;           
## [46] &quot;downloadFileUrl&quot;          &quot;downloadFileName&quot;         &quot;processedBy&quot;              &quot;reviewedBy&quot;               &quot;remarks.y&quot;               
## [51] &quot;dataQF.y&quot;                 &quot;publicationDate.y&quot;        &quot;release.y&quot;                &quot;spectralSampleCode.y&quot;     &quot;wavelength&quot;              
## [56] &quot;reflectanceCondition&quot;     &quot;reflectance&quot;              &quot;fileName&quot;

head(spectra_data[c(&quot;spectralSampleID&quot;,&quot;taxonID&quot;,&quot;reflectance&quot;,&quot;wavelength&quot;,&quot;reflectanceCondition&quot;)],1)

##         spectralSampleID taxonID reflectance wavelength                        reflectanceCondition
## 1 FSP_RMNP_20200706_2043   POTR5 0.103038183        350 top of foliage (sunward) on white reference
</code></pre>
<p>You’ll need to cast the wavelength and reflectance data to “numeric” data type, using <code>as.numeric</code>in order to plot the data.</p>
<pre><code>spectra_data$wavelength &lt;- as.numeric(spectra_data$wavelength)

spectra_data$reflectance &lt;- as.numeric(spectra_data$reflectance)
</code></pre>
<p>The spectral data is mainly composed of 3 columns: <code>wavelength</code>, <code>reflectanceCondition</code>, and <code>reflectance</code>. What is the <code>reflectanceCondition</code>? Let’s look at the unique values represented:</p>
<pre><code>unique(spectra_data$reflectanceCondition)

## [1] &quot;top of foliage (sunward) on white reference&quot;     &quot;bottom of foliage (downward) on white reference&quot; &quot;black reference&quot;                                
## [4] &quot;top of foliage (sunward) on black reference&quot;     &quot;bottom of foliage (downward) on black reference&quot;
</code></pre>
<p>This <code>reflectanceCondition</code> describes what exactly is being measured. As stated in the Field spectral data Quick Start Guide on the NEON Data Portal <a href="https://data.neonscience.org/data-products/DP1.30012.001" target="_blank">Field spectral data (DP1.30012.001)</a> page, and explained in more detail in the <a href="https://data.neonscience.org/api/v0/documents/NEON_fieldSpectra_userGuide_vC?inline=true" target="_blank">NEON Field Spectra User Guide</a>:</p>
<blockquote>
<p>“Spectral reflectance of both the front and back of the sample is measured against a reflective white spectralon reference panel. A black spectralon reference is then measured, followed by spectral transmittance measurements of the front and back of the sample. Reference measurements of the white reference are taken between each leaf measurement.”</p>
</blockquote>
<pre><code>first_spectra_plot &lt;- ggplot(subset(spectra_data, spectralSampleID == &quot;FSP_RMNP_20200706_2043&quot;), 
                             aes(x =wavelength, y = reflectance,
                                 color = reflectanceCondition)) + geom_line() 

print(first_spectra_plot + ggtitle(&quot;FSP_RMNP_20200706_2043 spectra, all reflectance conditions&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-first-fsp-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>When linking with NEON’s airborne spectral dataset (DP3.30006.001), the <code>top of foliage (sunward) on black reference</code> is the condition that we want to use. For this lesson, we will just focus on this reflectance condition. Let’s take a look at the spectra for the single csv we read in.</p>
<p>To subset to plot only the top of foliage on black reference we can add 2nd condition:</p>
<pre><code>first_spectra_plot &lt;- ggplot(subset(spectra_data, spectralSampleID == &quot;FSP_RMNP_20200706_2043&quot; &amp; reflectanceCondition == &quot;top of foliage (sunward) on black reference&quot;), aes(x =wavelength, y = reflectance, color = reflectanceCondition)) + geom_line() 

print(first_spectra_plot + ggtitle(&quot;FSP_RMNP_20200706_2043 spectra, top of foliage on black reference&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-first-fsp-top-black-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Next, let’s plot the spectra of all the samples. First, let’s extract only the reflectance condition we are interested in.</p>
<pre><code>spectra_top_black &lt;- spectra_data %&gt;% dplyr::filter(reflectanceCondition == &quot;top of foliage (sunward) on black reference&quot;)


ggplot(spectra_top_black, 
       aes(x =wavelength, y = reflectance,
           color = spectralSampleID)) + geom_line() 
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-all-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
Plot the spectra by taxon ID as follows:
<pre><code>ggplot(spectra_top_black, 
       aes(x =wavelength, y = reflectance,
           color = taxonID)) + geom_line(alpha = 0.5) 
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-by-species-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>We can see there are 7 different species represented. We can get the count of each of the taxonIDs as follows. The <code>filter(wavelength == 350)</code> makes it so that we are not counting all 426 bands for each sample.</p>
<pre><code>spectra_top_black %&gt;% 
  filter(wavelength == 350) %&gt;% 
  count(taxonID, sort = TRUE)

##   taxonID n
## 1   PICOL 5
## 2   PIPOS 5
## 3   POTR5 5
## 4    PIEN 3
## 5   PIFL2 3
## 6    PSME 3
## 7   ABLAL 1
</code></pre>
<p>Let’s dig in a a little more into the <code>taxonID</code>s` which have multiple field spectra measurements. PICOL, PIPOS, and POTR5 each have 5 samples - these are the more common tree species at RMNP. Let’s look at the spectra only from PICOL to start. For more details on this species, you can refer to the USDA <a href="https://plants.sc.egov.usda.gov/home/plantProfile?symbol=PICOL" target="_blank">PICOL</a> plant profile page - we can see here that the common name of this species is “Lodgepole Pine”.</p>
<pre><code>picol_spectra_plot &lt;- ggplot(subset(spectra_top_black, taxonID == &quot;PICOL&quot;), 
                             aes(x =wavelength, y = reflectance,
                                 color = spectralSampleID)) + geom_line() 

print(picol_spectra_plot + ggtitle(&quot;Spectra of PICOL samples collected at RMNP&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
What do you notice about these spectra? It looks like there is some variation between some of the samples, particularly in the visible portion of the spectrum. Let's go back to the original `spectra_merge` dataframe to see if we can determine more information about these individual samples. The code below pulls out some relevant columns from the data frame which may explain some of the variation we're seeing.
<pre><code>spectra_top_black[which(spectra_top_black$taxonID == &quot;PICOL&quot; &amp; spectra_top_black$wavelength == 350), c(&quot;taxonID&quot;,&quot;spectralSampleID&quot;,&quot;plantStatus&quot;,&quot;leafStatus&quot;,&quot;leafAge&quot;,&quot;leafExposure&quot;,&quot;leafSamplePosition&quot;,&quot;targetType&quot;,&quot;targetStatus&quot;,&quot;measurementVenue&quot;,&quot;remarks.y&quot;)]

##       taxonID       spectralSampleID plantStatus leafStatus leafAge leafExposure leafSamplePosition   targetType targetStatus measurementVenue
## 4303    PICOL FSP_RMNP_20200706_2120          OK    healthy  mature     part-sun             middle pure foliage        fresh       laboratory
## 15058   PICOL FSP_RMNP_20200709_2050          OK    healthy  mature       sunlit                top pure foliage        fresh       laboratory
## 19360   PICOL FSP_RMNP_20200713_1117          OK    healthy  mature       sunlit             middle pure foliage        fresh       laboratory
## 43021   PICOL FSP_RMNP_20200720_1304          OK    healthy  mature       sunlit                top pure foliage        fresh       laboratory
## 49474   PICOL FSP_RMNP_20200721_1243          OK    healthy  mature       sunlit             middle pure foliage        fresh       laboratory
##                                              remarks.y
## 4303                           all parallel needle mat
## 15058            RMNP bristlecone pine long needle mat
## 19360           PICOL-2 horizontal needle mat sample 2
## 43021 cfc.RMNP005.PICOL2-1.20200720 tape on both sides
## 49474                     cfc.RMNP006.PICOL-1.20200721
</code></pre>
<p>Here, we can see that all the plants have an “OK” status, and all the leaves have a “healthy” status, but the <code>leafExposure</code> and <code>leafSamplePosition</code> vary between the samples. This may cause some variation in the spectral signature. Some variation is expected, even if all conditions are identical, as there is uncertainty associated with any measurement, due to the properties of the leaf being sample, and the measurements themselves.</p>
<p>Let’s also plot the spectra of one of the other more common Rocky Mountain species: <a href="https://plants.sc.egov.usda.gov/home/plantProfile?symbol=POTR5" target="_blank">POTR5 (Quaking Aspen)</a>, to explore some of the typical variation you might see in the spectral signatures of a single species.</p>
<pre><code>potr5_spectra_plot &lt;- ggplot(subset(spectra_top_black, taxonID == &quot;POTR5&quot;), 
                             aes(x =wavelength, y = reflectance,
                                 color = spectralSampleID)) + geom_line() 

print(potr5_spectra_plot + ggtitle(&quot;Spectra of POTR5 samples collected at RMNP&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-potr5-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Finally, it may be useful to plot the spectra of two species on the same plot in order to compare the signatures. For this example, we’ll show PICOL (Lodgepole Pine) and POTR5 (Quaking Aspen) together, including all 5 measurements of each.</p>
<pre><code>potr5_picol_plot &lt;- ggplot(subset(spectra_top_black, taxonID %in% c(&quot;POTR5&quot;,&quot;PICOL&quot;)), 
                             aes(x =wavelength, y = reflectance,
                                 color = taxonID)) + geom_line(alpha = 0.5) 

print(potr5_picol_plot + ggtitle(&quot;Comparison PICOL (Lodgepole Pine) and POTR5 (Aspen) Leaf sample spectra at RMNP&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-potr5-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Here we can see that while there is considerable overlap in the visible portion of the electromagnetic spectrum, there are some distinct differences in the spectral signatures between these two species, particularly in the near to shortwave infrared regions.</p>
<h2 id="foliar-trait-data">Foliar Trait Data</h2>
<p>As described in the Field Spectra Data Quick Start Guide,</p>
<blockquote>
<p>“To find the geographic location of each plant, use the plant crown shapefiles in the Plant foliar physical and chemical properties data product (DP1.10026.001, table cfc_shapefile). For the locations of plants that have not been mapped to shapefiles, follow the instructions in the Data Product User Guide for DP1.10026.001.”</p>
</blockquote>
<p>This next section outlines how you would go about finding the geolocation information for the field spectra data. This is necessary if you are doing any sort of scaling exercise with the AOP hyperspectral data, which we will demonstrate next.</p>
<p>Let’s start by looking at the product information for this foliar trait data product. As before, you can un-comment the <code>#View</code> lines to explore this dataset more.</p>
<pre><code>foliar_trait_info &lt;- neonUtilities::getProductInfo('DP1.10026.001')

#View(foliar_trait_info$siteCodes)

#View(foliar_trait_info$siteCodes$availableDataUrls)
</code></pre>
<p>We can get the <code>availableDataUrls</code> of the RMNP site as follows:</p>
<pre><code># view the RMNP foliar trait available data urls

foliar_trait_info$siteCodes[which(foliar_trait_info$siteCodes$siteCode == 'RMNP'),c(&quot;availableDataUrls&quot;)]

## [[1]]
## [1] &quot;https://data.neonscience.org/api/v0/data/DP1.10026.001/RMNP/2020-07&quot;
</code></pre>
<p>Let’s download the foliar trait data from 2020-07 at RMNP to obtain the precise location information of the foliar spectra samples.</p>
<pre><code>foliar_traits &lt;- loadByProduct(dpID='DP1.10026.001',
                               site='RMNP',
                               startdate='2020-07',
                               package=&quot;expanded&quot;,
                               check.size=FALSE)

names(foliar_traits)
</code></pre>
<p>We can use the <code>geoNEON</code> package to obtain the refined geolocation information, based on product-specific rules and spatial designs. For more details on this package, please refer to the <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neon-spatial-data-basics" target="_blank">Access and Work with NEON Geolocation Data</a> tutorial.</p>
<pre><code>vst.loc &lt;- getLocTOS(data=foliar_traits$vst_mappingandtagging,
                     dataProd=&quot;vst_mappingandtagging&quot;)
</code></pre>
<p>Now let’s merge the foliar traits <code>cfc_fieldData</code> with this <code>vst.loc</code> data, which now includes the refined (adjusted) locations.</p>
<pre><code>foliar_traits_loc &lt;- merge(foliar_traits$cfc_fieldData,vst.loc,by=&quot;individualID&quot;)
</code></pre>
<p>Finally, we can merge this <code>foliar_traits_loc</code> data frame with the <code>spectra_merge</code> data frame by the <code>sampleID</code> in order to link the field spectra samples with the geolocation information. Note that there is also a <code>crownPolygonID</code> column, which contains the id of the crown polygon shape file. We will hold off on using this crown polygon for now, but will start by using the adjusted geolocations calculated using <code>geoNEON</code> to obtain the corresponding airborne reflectance data.</p>
<pre><code>spectra_traits &lt;- merge(spectra_top_black,foliar_traits_loc,by=&quot;sampleID&quot;)

head(spectra_traits[c(&quot;spectralSampleID&quot;,&quot;locationID&quot;,&quot;tagID&quot;,&quot;taxonID&quot;,&quot;stemDistance&quot;,&quot;stemAzimuth&quot;,&quot;adjEasting&quot;,&quot;adjNorthing&quot;)])

##         spectralSampleID            locationID tagID taxonID stemDistance stemAzimuth adjEasting adjNorthing
## 1 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
## 2 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
## 3 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
## 4 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
## 5 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
## 6 FSP_RMNP_20200716_1215 RMNP_009.basePlot.cfc  3861   POTR5         10.4        28.3     459058     4450439
</code></pre>
<p>Great, now we have the field spectra data and the corresponding locations of the leaf-clip samples.</p>
<h2 id="airborne-reflectance-data">Airborne Reflectance Data</h2>
<p>For the final part of this lesson, we will download the airborne reflectance data, and use some pre-defined functions to read the reflectance data into a <code>terra:rast</code> Spatial Object, and extract the spectral signature of the pixel corresponding to the location of the leaf-clip sample. We can use the <code>neonUtilities::byTileAOP</code> function to download only the 1km x 1km tile that contains the data we’re interested in. First, let’s set the working directory to where we want to download the data.</p>
<pre><code># set working directory (this will depend on your local environment)

wd &lt;- &quot;~/data/&quot;

setwd(wd)
</code></pre>
<p>We will download the corresponding reflectance spectra of the pixel corresponding to where a single PICOL sample was located. Let’s extract that sample from the <code>spectral_traits</code> table so we can easily pull out the geographic information.</p>
<pre><code>FSP_RMNP_PICOL &lt;- spectra_traits[spectra_traits$spectralSampleID == &quot;FSP_RMNP_20200720_1304&quot;,]
</code></pre>
<p>Check the <code>spectralSampleID</code> and <code>taxonID</code>:</p>
<pre><code>FSP_RMNP_PICOL$spectralSampleID[1]

## [1] &quot;FSP_RMNP_20200720_1304&quot;

FSP_RMNP_PICOL$taxonID[1]

## [1] &quot;PICOL&quot;
</code></pre>
<p>Download the reflectance data that encompasses this data point. Reflectance data can be quite large (~500-600+ MB per tile), so for this example, we’ll only download the single tile needed. We’ll leave the <code>check.size</code> field empty (default is TRUE), which means we will need to enter <code>y</code> in order to continue the download.</p>
<pre><code>byTileAOP(dpID='DP3.30006.001',

          site='RMNP',

          year=2020,

          easting=FSP_RMNP_PICOL$adjEasting,

          northing=FSP_RMNP_PICOL$adjNorthing,

          include.provisional=TRUE,

          savepath=wd)
</code></pre>
<p>This file will be downloaded into a nested subdirectory under the ~/data folder, inside a folder named DP3.30006.001 (the Data Product ID of the aerial reflectance data). The file should show up in this location: ~/data/DP3.30006.001/neon-aop-products/2020/FullSite/D10/2020_RMNP_3/L3/Spectrometer/Reflectance/NEON_D10_RMNP_DP3_455000_4446000_reflectance.h5. Let’s define an <code>h5_file</code> variable that points to the full path to this file.</p>
<pre><code># Define the h5 file name to be opened

h5_file &lt;- paste0(wd,&quot;DP3.30006.001/neon-aop-products/2020/FullSite/D10/2020_RMNP_3/L3/Spectrometer/Reflectance/NEON_D10_RMNP_DP3_455000_4446000_reflectance.h5&quot;)
</code></pre>
<p>Now we can use some pre-defined functions for working with the airborne reflectance data. For more details, please refer to the <a href="https://www.neonscience.org/resources/learning-hub/tutorials/introduction-hyperspectral-remote-sensing-data" target="_blank">Introduction to Hyperspectral Remote Sensing</a> tutorial series.</p>
<pre><code>geth5metadata &lt;- function(h5_file){
  # get the site name
  site &lt;- h5ls(h5_file)$group[2]
  
  # get the wavelengths
  wavelengths &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Metadata/Spectral_Data/Wavelength&quot;))
  
  # get the epsg code
  h5_epsg &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Metadata/Coordinate_System/EPSG Code&quot;))
                    
  # get the Reflectance_Data attributes
  refl_attrs &lt;- h5readAttributes(h5_file,paste0(site,&quot;/Reflectance/Reflectance_Data&quot;))
  
  # grab the UTM coordinates of the spatial extent
  xMin &lt;- refl_attrs$Spatial_Extent_meters[1]
  xMax &lt;- refl_attrs$Spatial_Extent_meters[2]
  yMin &lt;- refl_attrs$Spatial_Extent_meters[3]
  yMax &lt;- refl_attrs$Spatial_Extent_meters[4]
  
  ext &lt;- ext(xMin,xMax,yMin,yMax) # define the extent (left, right, top, bottom)

  no_data &lt;- as.integer(refl_attrs$Data_Ignore_Value)  # define the no data value
  meta_list &lt;- list(&quot;wavelengths&quot; = wavelengths, &quot;crs&quot; = crs(paste0(&quot;epsg:&quot;,h5_epsg)), &quot;raster_ext&quot; = ext, &quot;no_data_value&quot; = no_data)
  h5closeAll() # close all open h5 instances
  
  return(meta_list)
}



  band2Raster &lt;- function(h5_file, band, extent, crs, no_data_value){
    site &lt;- h5ls(h5_file)$group[2] # extract the site info
    # read in the raster for the band specified, this will be an array
    refl_array &lt;- h5read(h5_file,paste0(site,&quot;/Reflectance/Reflectance_Data&quot;),index=list(band,NULL,NULL))
	  refl_matrix &lt;- (refl_array[1,,]) # convert from array to matrix
	  refl_matrix &lt;- t(refl_matrix) # transpose data to fix flipped row and column order
    refl_matrix[refl_matrix == no_data_value] &lt;- NA     # assign data ignore values to NA
    refl_out &lt;- rast(refl_matrix,crs=crs) # write out as a raster
    ext(refl_out) &lt;- extent # assign the extents to the raster
    h5closeAll() # close all open h5 instances
    return(refl_out) # return the terra raster object
}
</code></pre>
<p>Now that we’ve defined these functions, we can run <code>lapply</code> on the band2Raster function, using all the bands. This may take a minute or two to run.</p>
<pre><code># get the relevant metadata using the geth5metadata function

h5_meta &lt;- geth5metadata(h5_file)



# get all bands - a consecutive list of integers from 1:426 (# of bands)

all_bands &lt;- as.list(1:length(h5_meta$wavelengths))



# lapply applies the function `band2Raster` to each element in the list `all_bands`

refl_list &lt;- lapply(all_bands,
                    FUN = band2Raster,
                    h5_file = h5_file,
                    extent = h5_meta$raster_ext,
                    crs = h5_meta$crs,
                    no_data_value = h5_meta$no_data_value)



refl_rast &lt;- rast(refl_list)
</code></pre>
<p>Let’s plot a single band (in the red wavelength) of the reflectance tile, for reference.</p>
<pre><code>plot(refl_rast[[58]])

#convert the data frame into a shape file (vector)

m &lt;- vect(cbind(FSP_RMNP_PICOL$adjEasting,
                FSP_RMNP_PICOL$adjNorthing), crs=h5_meta$crs)

# plot

plot(m, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-band58-1.png" alt=" " /></p>
<p>And we can zoom in on the sample location.</p>
<pre><code>x_sub = c(455100, 455200)

y_sub = c(4446500, 4446600)

plot(refl_rast[[58]],xlim=x_sub,ylim=y_sub)

plot(m, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-band58-zoom-1.png" alt=" " /></p>
<p>We can also plot an RGB image. First we’ll run <code>lapply</code> on the band2Raster function, this time using a list only consisting of the RGB bands:</p>
<pre><code>rgb &lt;- list(58,34,19)



# lapply tells R to apply the function to each element in the list

rgb_list &lt;- lapply(rgb,
                    FUN = band2Raster,
                    h5_file = h5_file,
                    extent = h5_meta$raster_ext,
                    crs = h5_meta$crs,
                    no_data_value = h5_meta$no_data_value)



rgb_rast &lt;- rast(rgb_list)
</code></pre>
<p>Plot the RGB of the entire 1km x 1km tile, as well as zoomed in on the sample location.</p>
<pre><code>plotRGB(rgb_rast,stretch='lin',axes=TRUE)

plot(m, col=&quot;red&quot;, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-refl-rgb-1.png" alt=" " /></p>
<pre><code>#zoom in

plotRGB(rgb_rast,stretch='lin',xlim=x_sub,ylim=y_sub)

plot(m, col=&quot;red&quot;, add = T)
</code></pre>
<p><img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-refl-rgb-2.png" alt=" " /></p>
<p>Next we can extract the aerial reflectance spectra using the <code>terra::extract</code> function as follows. We’ll create a data frame of the wavelengths and reflectance of that pixel.</p>
<pre><code>refl_air &lt;- extract(refl_rast, 
                    cbind(FSP_RMNP_PICOL$adjEasting[1],
                          FSP_RMNP_PICOL$adjNorthing[1]))



refl_air_df &lt;- data.frame(t(refl_air))

refl_air_df$wavelengths &lt;- h5_meta$wavelengths

names(refl_air_df) &lt;- c('reflectance','wavelength')



picol_air_plot &lt;- ggplot(refl_air_df,
                         aes(x=wavelength, 
                             y=reflectance)) + geom_line() + ylim(0,2500)

print(picol_air_plot + ggtitle(&quot;Airborne Reflectance Spectra of PICOL @ RMNP&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/extract-air-refl-spectra-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<h2 id="plotting-leaf-clip-and-airborne-data-together">Plotting Leaf-Clip and Airborne Data Together</h2>
<p>Finally, let’s make a plot of these two spectra (leaf-clip and aerial reflectance) together.</p>
<pre><code># scale the airborne reflectance by the scale factor

refl_air_df$scaled &lt;- (refl_air_df$reflectance/as.vector(10000))



spectra_plot &lt;- ggplot() + 
  geom_line(data=refl_air_df, aes(x=wavelength, y=scaled), color='green', show.legend=TRUE) +
  geom_line(data=FSP_RMNP_PICOL, aes(x =wavelength, y = reflectance), color = &quot;darkgreen&quot;, show.legend=TRUE) +
  labs(x=&quot;Wavelength (nm)&quot;,  y=&quot;Reflectance&quot;) +
  theme(legend.position = c(2500, 0.3)) +  ylim(0, 0.6)



print(spectra_plot + ggtitle(&quot;Spectra of PICOL Leaf Clip &amp; Corresponding Airborne Pixel at RMNP&quot;))
</code></pre>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/tutorials/R/AOP/Hyperspectral/Field-Spectra/rfigs/plot-picol-spectra-both-1.png" alt=" "  />
<p class="caption"> </p>
</div>
<p>Why is there a difference between the leaf-clip spectra and the remotely-sensed spectra of the corresponding pixel? Here are a few things to consider …</p>
<p>Each reflectance pixel represents a 1m x 1m area, so it contains an average spectra of all the vegetation and non-vegetation that are contained in that area. For example, a single pixel could contain the reflectance of a mix of leaves as well as branches, and any gaps in the tree canopy (eg. the ground under the tree). This averaging is called “spectral mixing” and you can perform “spectral un-mixing” to decompose an average spectra into it’s component parts. These leaf clip spectra can be used as “end-members”, in classification applications, for example.</p>
<p>Also, it is important to understand that there are uncertainties in the ASD measurements as well as the airborne spectra. There may be some geographic uncertainty associated with both the airborne data (which has 0.5 m horizontal resolution), as well as with the field sample geolocations. There is also some uncertainty in the spectral data itself. For example, there is uncertainty resulting from the atmospheric correction applied when generating the reflectance data from the at-sensor-radiance. Weather conditions during the flight are important to consider as well. The Airborne Observation Platform attempts to collect the coincident overflights in clear weather, but this may not always be the case. For more on hyperspectral uncertainties and variation, please refer to the <a href="https://data.neonscience.org/api/v0/documents/NEON.DOC.004365vB?inline=true" target="_blank">Spectrometer Mosaic ATBD</a> (Algorithm Theoretical Basis Document).</p>
<h3 id="next-steps">Next Steps</h3>
<p>Hopefully this tutorial provides a bouncing-off point for more exploratory analysis and/or in-depth research. What else might you want to explore, using these three integrated datasets?</p>
<p>Here are some ideas to pursue on your own:</p>
<ol>
<li>
<p>We demonstrated how to plot the field spectral sample together with the airborne remotely sensed reflectance of the pixel. What if there is a geographic mis-match between the field and airborne data? What other approaches could you use to align these datasets (eg. applying a buffer, integrating the CHM data)?</p>
</li>
<li>
<p>Starting in 2020 (including RMNP 2020), the foliar traits data products include shape files of the polygons of the tree crowns where the samples are taken from. Try pulling in that tree crown shape files and plotting the average spectra inside the tree crown area.</p>
</li>
</ol>
<div id="ds-dataTip" markdown="1">
<p><i class="fa fa-star"></i> <strong>Data Tip:</strong> to see what crown polygon data are available, you can specify <code>tabl='cfc_shapefile'</code> in the <code>loadByProduct</code> function:</p>
<pre><code>polygons &lt;- loadByProduct(dpID='DP1.10026.001', 
                          tabl='cfc_shapefile', 
                          include.provisional=T,
                          check.size=F)
</code></pre>
</div>
</div>
</body>
</html>
