
##### EDIT is the tag for stuff that still needs to be done!


---
title: "Subsetting HDF5 files to make a smaller deliverable"
description: "Take a large HDF5 file and extract only the information that you need, then save as a new HDF5 file. For an example, we will take an existing hyperspectral dataset (~600Mb) and reduce it in size for subsequent tutorials."
dateCreated: 2020-02-04 14:20:52
authors: Donal O'Leary
contributors: 
estimatedTime: 1.0 Hours
packagesLibraries: rhdf5, raster
topics: hyperspectral, HDF5, remote-sensing
languagesTool: R
dataProudct: ##### EDIT
code1: ##### EDIT
tutorialSeries: ##### EDIT 
urlTitle: ##### EDIT
---

In this tutorial, we will subset an existing HDF5 file containing NEON
hyperspectral data. The purpose of this exercise is to generate a smaller
file for use in subsequent tuorials.

<div id="ds-objectives" markdown="1">

## Learning Objectives

After completing this activity, you will be able to:

* Navigate an HDF5 file to identify the variables of interest.</li>
* Generate a new HDF5 file from a subset of the existing dataset.</li>
* Save the new HDF5 file for future use.

## Things Youâ€™ll Need To Complete This Tutorial
To complete this tutorial you will need the most current version of R and, 
preferably, RStudio loaded on your computer.

### R Libraries to Install:

* **rhdf5**: `install.packages("BiocManager")`, `BiocManager::install("rhdf5")`
* **raster**: `install.packages('raster')`

<a href="{{ site.baseurl }}/packages-in-r" target="_blank"> More on Packages in
 R - Adapted from Software Carpentry.</a>

### Data to Download

{% include/dataSubsets/##########.html %} ##### EDIT should be full 1km hyperspectral HDF5

***
{% include/_greyBox-wd-rscript.html %}  ##### EDIT
***

### Recommended Skills

##### EDIT this should be changed, as this tutorial will take place /before/ the hyperspectral lessons!

If you haven't already, we highly recommend you work through the 
<a href="{{ site.baseurl }}/########" target="_blank"> *Introduction to Working with HDF5 Format in R* series</a>
before moving on to this tutorial.

</div>


## Why subset your dataset? 
There are many reasons why you may wish to subset you HDF5 file.
Primarily, HDF5 files may contain a large amount of information
that is not necessary for your purposes. By subsetting the file,
you can reduce file size, thereby shrinking your storage needs,
and shortening file transfer/download times. In this example, we
will take a full HDF5 file of NEON hyperspectral reflectance data
from the San Joaquin Experimental Range (SJER) that has a file size
of `652 Mb` and make a new HDF5 file with a reduced spatial extent,
and a reduced spectral resolution, yeilding a file of only `50.1 Mb`.
This reduction in file size will make it easier and faster to share
your data with others. We will then use this subsetted file in the
#### EDIT - ADD LINK  "introduction to hyperspectral..." tutorial series.

If you find that downloading the full `652 Mb` file takes too much
time or storage space, you will find a link to this subsetted file
at the top of the ##### EDIT - ADD LINK "introduction to hyperspectral..." tutorial series page.

First, we will load the required library for this tutorial:

```{r load-libraries}

# Install rhdf5 package (only need to run if not already installed)
#install.packages("BiocManager")
#BiocManager::install("rhdf5")

# Load required packages
library(rhdf5)

```

Next, we define our working directory where we have saved the full HDF5 
file of NEON hyperspectral reflectance data from the SJER site. Note,
the filepath to the working directory will depend on your local environment.
Then, we create a string (`f`) of the HDF5 filename and read its attributes.

```{r read-in-file }
# set working directory to ensure R can find the file we wish to import and where
# we want to save our files. Be sure to move the download into your working directory!
wd="~/Desktop/Hyperspectral_Tutorial/" #This will depend on your local environment
setwd(wd)

# Read in H5 file
#f <- paste0(wd,"NEONDSImagingSpectrometerData.h5")
f <- paste0(wd,"NEON_D17_SJER_DP3_257000_4112000_reflectance.h5")
#View HDF5 file structure 
h5ls(f,all=T)

```

Now, we create a new empty HDF5 file, and then populate this file with the
groups that we need to save our essential information for this subset.
Note that the function `h5createFile()` will not overwrite an existing
file. Therefore, if you have already created or downloaded this file, the
function will throw an error!

```{r create-hdf5}
setwd(wd)
# create hdf5 file
h5createFile("NEON_hyperspectral_tutorial_example_subset.h5")
# create group for location 1
h5createGroup("NEON_hyperspectral_tutorial_example_subset.h5", "SJER/")
h5createGroup("NEON_hyperspectral_tutorial_example_subset.h5", "SJER/Reflectance")
h5createGroup("NEON_hyperspectral_tutorial_example_subset.h5", "SJER/Reflectance/Metadata")
h5createGroup("NEON_hyperspectral_tutorial_example_subset.h5", "SJER/Reflectance/Metadata/Coordinate_System")
h5createGroup("NEON_hyperspectral_tutorial_example_subset.h5", "SJER/Reflectance/Metadata/Spectral_Data")


```




```{r populate group attributes}

ls=h5ls(f,all=T)

#make a list of all of the names within the Coordinate_System group
cg=unique(ls[ls$group=="/SJER/Reflectance/Metadata/Coordinate_System",]$name)

for(i in 1:length(cg)){
  print(cg[i])
  a=h5readAttributes(f,paste0("/SJER/Reflectance/Metadata/Coordinate_System/",cg[i]))
  d=h5read(f,paste0("/SJER/Reflectance/Metadata/Coordinate_System/",cg[i]))
  attributes(d)=a
  h5write(obj=d,file="NEON_hyperspectral_tutorial_example_subset.h5",
          name=paste0("/SJER/Reflectance/Metadata/Coordinate_System/",cg[i]),
          write.attributes=T)
}

```

